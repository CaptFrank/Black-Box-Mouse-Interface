<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.4"/>
<title>Arduino Medical Assitive Device Base Station: USB_DEVICE Class Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../MS_01.jpgc4ca71fd-46e9-4709-a41a-6789ac1c60d6Small.jpg"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Arduino Medical Assitive Device Base Station
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">A base station for the wireless medical device platform</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.4 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="../../index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="../../files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="../../search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="../../search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="../../annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="../../classes.html"><span>Data&#160;Structure&#160;Index</span></a></li>
      <li><a href="../../functions.html"><span>Data&#160;Fields</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d4/d27/class_u_s_b___d_e_v_i_c_e.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Macros</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-methods">Public Member Functions</a>  </div>
  <div class="headertitle">
<div class="title">USB_DEVICE Class Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p><code>#include &lt;<a class="el" href="../../d2/d75/_u_s_b___device___implementation_8h_source.html">USB_Device_Implementation.h</a>&gt;</code></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a8237f16f402e2d922ab4502849362b4b"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d27/class_u_s_b___d_e_v_i_c_e.html#a8237f16f402e2d922ab4502849362b4b">USB_DEVICE</a> ()</td></tr>
<tr class="memdesc:a8237f16f402e2d922ab4502849362b4b"><td class="mdescLeft">&#160;</td><td class="mdescRight">Default Constructor.  <a href="#a8237f16f402e2d922ab4502849362b4b">More...</a><br/></td></tr>
<tr class="separator:a8237f16f402e2d922ab4502849362b4b"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a98fbf9b9aae2f3cc64c0007933326e25"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../d4/d27/class_u_s_b___d_e_v_i_c_e.html#a98fbf9b9aae2f3cc64c0007933326e25">run_usb</a> ()</td></tr>
<tr class="separator:a98fbf9b9aae2f3cc64c0007933326e25"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>GENERAL INFO ABOUT USB DEVICE FUNCTIONS This is the procedures to gain access to the sensor values on the remote sensors. This document is meant to be a guideline for the future application layer protocol developemnt.</p>
<p>This state is accessed when the Arduino ADK (Ground station) needs to map out the network at hand. This state requests a status report from the router, and the router sends a report of all sensors available and their ids and data types (includes number of bytes to allocate for the rx buffer).</p>
<p>NOTE: The IF(REMEMBER) condition is implemented using the DB.h library found on Arduino.com. It uses the EEPROM to store information\ about the configuration. </p>
<pre class="fragment">#if(ID_REQUEST)


       This function sends_a wakeup call to the router and makes the
       router go into command polling mode. This allows the router to
       only react to the commands sent by the ground station and not the
       sensors.

       -&gt; This function needs an ack before a watchdog timer expires
          to continue with the setup process.

     1. send_wakeup_router();
            -&gt; receive_router_ack();
            -&gt; ping_router


       This function requests a router status structure. It sends a
       request command and polls until a structure is returned or when a
       watchdog timer exhaust is caught.

       -&gt; This function needs an ack before a watchdog timer expires
          to continue with the setup process.

     2. request_router_status();
            -&gt; receive_router_status();


       This function is very crucial to the network implementation, as
       it maps out the receiver and sender nodes. This function sends a
       generic "nmap" command, which activates a network_read() command on
       the router. Then in turn, the router returns a network structure,
       which contains enddevice information and other crucial network info.

       -&gt; This function needs a message before a watchdog timer expires
          to continue with the setup process.

     3. request_net_map();
            -&gt; receive_nmap();


               This part of the code stores the received network info in
               non-volatile EEPROM for future storage.\

            IF(REMEMBER)
                -&gt; store_into_sensor_db(nmap_t* nmap);
            ENDIF


       Now that the network topology is mapped out, the follwoing command
       is issued to all endpoint devices (sensors) to acquire their
       respective specifics, such as channel IDs, speed and data types.

       -&gt; This function needs a message before a watchdog timer expires
          to continue with the setup process.

     4. request_sensor_channel_info();
            -&gt; receive_channel_info();


               This part of the code stores the received network info in
               non-volatile EEPROM for future storage.\

            IF(REMEMBER)
                -&gt; store_into_sensor_db(channel_info_t* channel_info);
            ENDIF


       This function polls for an enabled sensor report generated by the
       user on the router, by slecting which sensor is enabled.

     5. get_user_enable_sensors();
            -&gt; set_flags(byte sensor flags);


       Then to finalize the ground station network initialization,
       we need to allocate buffers for each sensor and then create a
       call priority table, which in other words is a call scheduler.
       This finalizes the network setup on the ground station side.

       -&gt; This function needs a message before a watchdog timer expires
          to continue with the setup process.

     6. configure_ground_station();
            -&gt; allocate_buffers(nampe_t* nmap, channel_info_t* channel_info);
            -&gt; create_call_priority_table();
#ENDIF
</pre><p>This state is reached when we have successfully finished the init stage and we are requesting data from the router. </p>
<pre class="fragment">#IF(RUN_REQUEST)


       This function checks the sensor states based off the argument passed.
       This function reveives 1 byte from the router that contains the
       bianry equivalent of the states of the sensors
        -&gt; HIGH = ON
        -&gt; LOW  = OFF

       -&gt; This function needs a message before a watchdog timer expires
          to continue with the setup process.

     7. check_sensors_state(byte* sensor_flags);
        -&gt; byte receive_sensor_states();
</pre><p>This part is the working loop for the transaction based protocol. It is an INFINITE loop that is only disturbed by the USER I/O on the chronos or an ERROR. </p>
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<p>for INFINITY || Interrupt occurs (I/O or ERROR)</p>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p>For each sensor, we must do teh following tasks. </p>
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<blockquote class="doxtable">
<p>for # of sensors</p>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<p></p>
</blockquote>
<pre class="fragment">               This function sends a wakeup message to the router, which
               in its turn sends a wakeup signal to the remote node
               specified in the agument passed.

               -&gt; This function needs a message before a watchdog timer expires
                  to continue with the setup process.

             8. send_sensors_wakeup(byte* sensor_flags);
                -&gt; receive_router_ack();

               This function sends a sensor data request query to the router,
               which then gets a sensor responce structure back. The sequence
               in which this process is done is with the call_priority_table
               defined above. We go through the table and call each sensor
               to get each peice of information.

               This function receives a router ACK structure, and also receives,
               a data point objcet. All of which are processed, and passed to
               the USB HID object, which then is passed to the CPU.

             9. send_sensor_query(call_priority_table_t* table);
                -&gt; receive_router_ack();
                -&gt; receive_data_points();
#ENDIF
</pre><p>This state is reached when either an error occurs on the router side or an error occurs on the remote sensor side. This is a polling interrupt. All systems are stopped when this occurs, or failsafe/debug mode is activated. </p>
<pre class="fragment">#IF(ERROR)

       This function presents the interrupt procedure for a remote error.
       First we receive the error message with the cause, and then we reboot
       The erroneous device. We must make sure to dealloc or free() the mem
       used for the device. We must make sure that the device saves its
       configs and loads them after reboot. We must also make sure that the
       device node is then powered up correctly afterwards.

     interrupt_process();
        -&gt; receive_error_msg(); // contains cause.
        -&gt; send_save_configs_msg(byte* device_node);
        -&gt; reboot_erroneous_device(byte* device_node);
        -&gt; check_remote_configs(byte* device_node);
        -&gt; reinsert_into_ntwk(byte* device_node);

#ENDIF  </pre> 
<p>Definition at line <a class="el" href="../../d2/d75/_u_s_b___device___implementation_8h_source.html#l00193">193</a> of file <a class="el" href="../../d2/d75/_u_s_b___device___implementation_8h_source.html">USB_Device_Implementation.h</a>.</p>
</div><h2 class="groupheader">Constructor &amp; Destructor Documentation</h2>
<a class="anchor" id="a8237f16f402e2d922ab4502849362b4b"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">USB_DEVICE::USB_DEVICE </td>
          <td>(</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Default Constructor. </p>
<p>The class constructor </p>
<p>Sending mutex</p>
<p>Initializing the enviroment variables </p>

<p>Definition at line <a class="el" href="../../db/d6f/_u_s_b___device___implementation_8cpp_source.html#l00018">18</a> of file <a class="el" href="../../db/d6f/_u_s_b___device___implementation_8cpp_source.html">USB_Device_Implementation.cpp</a>.</p>

</div>
</div>
<h2 class="groupheader">Member Function Documentation</h2>
<a class="anchor" id="a98fbf9b9aae2f3cc64c0007933326e25"></a>
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void USB_DEVICE::run_usb </td>
          <td>(</td>
          <td class="paramname">)</td><td></td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Runs the usb device </p>
<p>Sets up the rf network</p>
<p>Once the state machine gets here, it polls for data from the router and parses it into the structures.</p>
<p>Poll the USB Line</p>
<p>Check to see if a report needs to be sent, using the idle rate.</p>
<p>Needs to send</p>
<p>Create a valid random USB Frame</p>
<p>Poll the USB Line</p>
<p>If we need to send.</p>
<p>Send the report. and reset the timer.</p>
<p>Poll the USB line</p>
<p>No need to send anymore. </p>

<p>Definition at line <a class="el" href="../../db/d6f/_u_s_b___device___implementation_8cpp_source.html#l00029">29</a> of file <a class="el" href="../../db/d6f/_u_s_b___device___implementation_8cpp_source.html">USB_Device_Implementation.cpp</a>.</p>

</div>
</div>
<hr/>The documentation for this class was generated from the following files:<ul>
<li>Arduino_ADK_USB_HOST/USB_Device_Implementation/<a class="el" href="../../d2/d75/_u_s_b___device___implementation_8h_source.html">USB_Device_Implementation.h</a></li>
<li>Arduino_ADK_USB_HOST/USB_Device_Implementation/<a class="el" href="../../db/d6f/_u_s_b___device___implementation_8cpp_source.html">USB_Device_Implementation.cpp</a></li>
</ul>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d4/d27/class_u_s_b___d_e_v_i_c_e.html">USB_DEVICE</a></li>
    <li class="footer">Generated on Thu Aug 15 2013 18:16:11 for Arduino Medical Assitive Device Base Station by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.4 </li>
  </ul>
</div>
</body>
</html>
